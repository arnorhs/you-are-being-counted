---
import { type Period, queryHits } from '../lib/hits/queryHits'
import { recordHits } from '../lib/hits/recordHits'

const { slug = '' } = Astro.params

if (slug.includes('.')) {
  return Astro.redirect('/404')
}

const period = (Astro.url.searchParams.get('period') ?? 'hour') as Period
const path = `/${slug}`
await recordHits(path, new Date())
const { hits, max } = await queryHits(path, period, new Date())
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <title>You are being counted</title>
  </head>
  <body>
    <h1>You are being counted</h1>
    <h2>Visits to {path}</h2>
    <div class="flex w-full justify-between overflow-hidden">
      {
        hits.map((hit) => (
          <div class="relative h-[200px] w-[40px] bg-slate-100">
            <div
              class={`absolute bottom-0 left-[10px] w-[18px] bg-blue-500`}
              style={{
                height: `${Math.round((100 * hit.hits) / max)}%`,
              }}
            >
              <div
                class="
                  origin-bottom-right
                  translate-x-[-1px]
                  translate-y-[-10px]
                  -rotate-90
                  text-right
                  text-xs
                  font-bold
                  text-white
                "
              >
                {hit.hits}
              </div>
            </div>
          </div>
        ))
      }
    </div>
  </body>
</html>
